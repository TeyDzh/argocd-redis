apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: redis-app
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: redis
  source:
    repoURL: https://github.com/TeyDzh/argocd-redis.git
    targetRevision: HEAD
    path: dep
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
  sourceHelm:
    - releaseName: redis
      chart:
        repository: https://charts.bitnami.com/bitnami
        name: redis
        version: latest
      values:
        replica:
          enabled: true
          replicas: 2
        persistence:
          enabled: false
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - redis
          topologyKey: "kubernetes.io/hostname"
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: redis-node
                    operator: In
                    values:
                      - "true"
